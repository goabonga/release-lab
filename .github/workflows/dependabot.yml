name: ‚ôªÔ∏è Sign Dependabot Commits

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  sign-dependabot-commits:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: üîë Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          git config --global user.signingkey "$(gpg --list-secret-keys --keyid-format=LONG | grep sec | awk '{print $2}' | cut -d/ -f2)"
          git config --global commit.gpgsign true
          git config --global tag.gpgSign true
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: üîì Unlock GPG key
        run: |
          echo "test" | gpg --batch --yes --passphrase "$GPG_PASSPHRASE" --pinentry-mode loopback -s >/dev/null
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: üîß Configure Git user
        run: |
          git config --global user.name "Chris"
          git config --global user.email "goabonga@pm.me"

      - name: ‚úèÔ∏è Re-sign all commits in PR
        env:
          GIT_AUTHOR_NAME: "Chris"
          GIT_AUTHOR_EMAIL: "goabonga@pm.me"
          GIT_COMMITTER_NAME: "Chris"
          GIT_COMMITTER_EMAIL: "goabonga@pm.me"
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          git fetch origin main
          BASE=$(git merge-base HEAD origin/main)
          echo "üîÅ Rebase from: $BASE"
          export GIT_SEQUENCE_EDITOR="sed -i 's/^pick /edit /'"
          git rebase -i "$BASE" || true
          while [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ]; do
            echo "üîè Amending current commit with GPG and author..."
            git commit --amend --no-edit --reset-author -S
            git commit --amend --no-edit -S
            git rebase --continue || true
          done

      - name: üöÄ Force push changes
        run: |
          git remote set-url origin https://goabonga:${GH_TOKEN}@github.com/goabonga/release-lab.git
          git push origin HEAD:$BRANCH_NAME --force-with-lease
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH_NAME: ${{ github.head_ref }}
